---
title: "ICM testing"
output:
  pdf_document: default
  html_document: default
  word_document: 
    #reference_docx: template.docx
editor_options:
  chunk_output_type: console
---

The data is now available to test this on at least 81 stocks.  All of the NE Atlantic stocks (ICES) have been through the QA/QC process and we are happy with those data (Sept 1, 2022).  Let's see if we can get this to work on all the stocks with sufficient data... 

```{r, load-stuff,echo=F, message=F, warning=F, fig.width=6, fig.height=4}
# OK, so using the ICES assessments here's what we get for North Sea cod.
library(readxl)
library(tidyverse)
library(rio)
library(ggthemes)
library(cowplot)
library(gtable)
library(viridis)
loc <- 'D:/GitHub/ICM'

source(paste0(loc,"/Scripts/functions/tuning_sim_fast.R"))

# Download the functions we'll need from github
  funs <- c("https://raw.githubusercontent.com/dave-keith/ICM/main/Scripts/functions/simple_Lotka_r.r",
            "https://raw.githubusercontent.com/dave-keith/ICM/main/Scripts/functions/backwards_project.r",
            "https://raw.githubusercontent.com/dave-keith/ICM/main/Scripts/functions/forward_project.r",
            "https://raw.githubusercontent.com/dave-keith/ICM/main/Scripts/functions/tuning_sim_fast.R",
            
  )
  # Now run through a quick loop to load each one, just be sure that your working directory is read/write!
  for(fun in funs) 
  {
    download.file(fun,destfile = basename(fun))
    source(paste0(getwd(),"/",basename(fun)))
    file.remove(paste0(getwd(),"/",basename(fun)))
  }

# Choose 5 ICES stocks that we have the necessary data for
#ASR <- read_xlsx("../Data/ASR_2018.xlsx" sheet = "ICES")
ASR1 <- read.csv(paste0(loc,"/Data/ICM_data_NE_atlantic_stocks.csv"))
ASR <- read.csv(paste0(loc,"/Data/ICM_data_NW_atlantic_stocks.csv"))



ASR <- rbind(ASR1,ASR)
datatypes <- unique(gsub(x = names(ASR), pattern = "[^a-zA-Z]", replacement=""))

# Replace 0's in Num.tot with NA so the rest of this works as Freya designed it to...
ASR$Num.tot[ASR$Num.tot == 0] <- NA
# we want:
# Year, Num, WA, Catch, AM, NM, StockID, Management, Area, Order, Family, Genus, Species
ASRdat <- ASR[,c(grep(x=names(ASR), "Num"),
                 grep(x=names(ASR), "WA"),
                 grep(x=names(ASR), "Catch"),
                 grep(x=names(ASR), "AM"),
                 grep(x=names(ASR), "NM"))]
# Making all the data numeric that should be numeric
ASRdat <- apply(X = ASRdat, 2, as.numeric)
# Getting the species info back
ASRsp <- ASR[, which(!1:length(names(ASR)) %in% grep(x=names(ASR), ".", fixed=T))]
# And binding it all back together
ASR_trim <- cbind(ASRsp, ASRdat)
# need a unique ID for stock
#table(ASR_trim$Management, ASR_trim$Species)
ASR_trim$Stock <- paste0(ASR_trim$Management, "_", ASR_trim$Area, "_", ASR_trim$Genus, "_", ASR_trim$Species)

ASR_long <- ASR_trim %>%
  pivot_longer(!c("Management", "Area", "Order", "Family", "Genus", "Species", "Stock", "Year","Meeting_or_reference","Model","Case","Notes")) %>%
  separate(col=name, into=c("type", "age"), sep = "\\.")

# Something is weird with the mentella stock, I'm going to drop it...
ASR_long <- ASR_long %>% dplyr::filter(Stock != "ICES-AFWG_DEEP1-2_Sebastes_mentella")

```

```{r, prep-data,echo=F, message=F, warning=F, fig.width=6, fig.height=4}

Stocks <- ASR_long %>%
                    dplyr::filter(!is.na(value)) %>%
                    dplyr::group_by(Stock, type) %>%
                    dplyr::summarize(count=length(unique(value))) %>%
                    dplyr::group_by(Stock) %>%
                    dplyr::summarize(types=length(unique(type))) %>%
                    dplyr::filter(types==5) %>%
                    dplyr::select(Stock)

ASR_stocks <- ASR_long %>%
                        dplyr::filter(Stock %in% Stocks$Stock) %>%
                        dplyr::filter(!is.na(value)) %>%
                        dplyr::arrange(Stock, Year, type, as.numeric(age))

# Stocks <- ASR_stocks %>%
#                       dplyr::group_by(Stock, Species, type) %>%
#                       dplyr::summarize(ages=length(unique(age)),
#                                 years=length(unique(Year))) %>%
#                       dplyr::arrange(-years, -ages) %>%
#                       dplyr::filter(!Species=="morhua") %>%
#                       dplyr::distinct(Stock) %>%
#                       dplyr::pull(Stock)
# 
# print(Stocks)
Stocks <- Stocks$Stock

# Going to remove Sebastes norvegicus because we can't get fecundity as the only data we have is total numbers.
#Stocks <- Stocks[Stocks != "ICES-AFWG_DEEP1-2_Sebastes_norvegicus"]
# Esmarki doesn't work great as it is assessed using a quarterly model.
#Stocks <- Stocks[Stocks != "ICES-WGNSSK_NS 4-3aN_Trisopterus_esmarkii"]
#i = 'ICES-AFWG_NEA1-2_Melanogrammus_aeglefinus'
years.tmp <- NULL
pnm.tmp <- NULL
waa.tmp <- NULL
ages.tmp <- NULL
rem.tmp <- NULL
mx.tmp <- NULL
NE.tmp <- NULL
vpa.tmp <- NULL
am.tmp <- NULL
mr.tmp <- NULL
all.abund.tmp <- NULL
full.abund.tmp <- NULL
full.rem.tmp <- NULL
fs.tmp <- NULL
for(i in Stocks)
{
  print(i)
  ASR_sub <- ASR_long %>%
    dplyr::select(Year, Stock, type, age, value) %>%
    dplyr::filter(Stock==i)

  # Drop the NA years....
  if(i == "ICES-NWWG_ICE-Summer_Clupea_harengus") ASR_sub <- ASR_sub %>% dplyr::filter(Year > 1986)
  # There's some funkiness going on in the first 7 years of these data, so staring in year 8
  if( i == "ICES-WGNSSK_NS  4-6a-20_Melanogrammus_aeglefinus") ASR_sub <- ASR_sub %>% dplyr::filter(Year > 1971)
  if(i == "ICES-NWWG_FA5b_Pollachius_virens") ASR_sub <- ASR_sub %>% dplyr::filter(Year > 1982)
  if(i == "ICES-NWWG_FA5a_Pollachius_virens") ASR_sub <- ASR_sub %>% dplyr::filter(Year > 1984)
  if(i == "ICES-AFWG_NEA1-2_Pollachius_virens") ASR_sub <- ASR_sub %>% dplyr::filter(Year > 1969)
  if(i == "ICES-WGCSE_CS27.6a_Merlangius_merlangus") ASR_sub <- ASR_sub %>% dplyr::filter(Year > 1980)
  if(i == "ICES-WGCSE_NS6a_Gadus_morhua") ASR_sub <- ASR_sub %>% dplyr::filter(Year > 1980)
  if(i == "ICES-AFWG_COASTNOR 1-2_Gadus_morhua") ASR_sub <- ASR_sub %>% dplyr::filter(Year > 2006)
  if(i == "NEFSC_5Z_Pseudopleuronectes_americanus") ASR_sub <- ASR_sub %>% dplyr::filter(Year > 1982)
  if(i == "ICES-WGNSSK_NS 4-7d_Merlangius_merlangus") ASR_sub <- ASR_sub %>% dplyr::filter(Year > 1989)
  
  # maxage <- max(as.numeric(ASR_sub$age[!is.na(ASR_sub$value)]))
  # maxYear <- max(ASR_sub$Year[!is.na(ASR_sub$value)])
  # minYear <- min(ASR_sub$Year[!is.na(ASR_sub$value)])
  # forplot <- ASR_sub[as.numeric(ASR_sub$age) < (maxage+1) & ASR_sub$Year %in% minYear:maxYear,]
  # 
  # # summary plots
  # print(ggplot() + geom_line(data=forplot, aes(Year, value)) + facet_grid(type~as.numeric(age), scales="free_y") +
  #         geom_vline(data=forplot[is.na(forplot$value),], aes(xintercept=Year), colour="red") + facet_grid(type~as.numeric(age), scales="free_y") +
  #         theme_bw() + 
  #         ggtitle(i)
  # )
  
  age.mat <- ASR_sub %>% dplyr::filter(type=="AM") %>% dplyr::rename(AM=value) %>% dplyr::select(-type)
  # All of the age at maturities are NA in 0 and 1 year olds, so make them 0's, do that carefully just
  # in case that changes later...
  am.0s <- length(which((!is.na(age.mat$AM[age.mat$age ==0]))))
  am.1s <- length(which((!is.na(age.mat$AM[age.mat$age ==1]))))
  am.2s <- length(which((!is.na(age.mat$AM[age.mat$age ==2]))))
  am.3s <- length(which((!is.na(age.mat$AM[age.mat$age ==3]))))
  if(am.0s == 0) age.mat$AM[age.mat$age ==0] <- 0
  if(am.1s == 0) age.mat$AM[age.mat$age ==1] <- 0
  if(am.2s == 0) age.mat$AM[age.mat$age ==2] <- 0
  if(am.3s == 0) age.mat$AM[age.mat$age ==3] <- 0
  
   # Now we can get the abundance from the VPA models
  abund <- ASR_sub %>% dplyr::filter(type=="Num") %>% dplyr::rename(Num=value) %>% dplyr::select(-type)
  
  #if(am.1s | am.0s | am.2s > 0) print("Stop, you need to check the age at maturity for either age 0 or 1 as there is data in there.")
  # Now do something similar for the Natural moralities, but in this case
  # we take the NM of the youngest age class we have information for and back that number up to year 0.
  # DK NOTE:  THIS IS A BIG CHANGE IN DIRECTION FOR THE LOTKA CALCS SO NEED TO NOTE THIS ONE!!
  
  
  nm.tmp <-  ASR_sub %>% dplyr::filter(type=="NM") %>% dplyr::rename(NM=value) %>% dplyr::select(-type)
  
  #minage
  minage <- min(as.numeric(nm.tmp$age[!is.na(nm.tmp$NM)]))
  if(minage == 0)  nat.mort <- nm.tmp
  # Some specials...
  if(i %in% c("ICES-WGCSE_CS7e-k_Gadus_morhua","ICES-WGCSE_ROCK6b_Melanogrammus_aeglefinus",
              "ICES-WGHANSA_SP8abd_Sardina _pilchardus","ICES-WGWIDE_NEA 1-9,12,14_Micromesistius_poutassou")) minage <- 1
  if(i == "ICES-WGWIDE_NEA 1,2,5,4a,14a_clupea_ harengus") minage <- 2
  #maxage
  maxage <- max(as.numeric(nm.tmp$age[!is.na(nm.tmp$NM)]))
  
  # Now get the number of individuals in the youngest age category
  num.age.min <- ASR_sub %>% dplyr::filter(age==minage,type=="Num")
  # So any Recruitment even that is > 3 SE's away from the median I'm calling 
  # an 'extreme' recruitment event and it is going to get a lower/higher natural mortality term.
  med.mun.age.min <- mean(num.age.min$value,na.rm=T)
  sd.mun.age.min <- sd(num.age.min$value,na.rm=T)#/sqrt(length(na.omit(num.age.min$value)))
  low.rec <- med.mun.age.min - 2*sd.mun.age.min
  high.rec <- med.mun.age.min + 2*sd.mun.age.min
  high.rec.years <- as.vector(na.omit(num.age.min$Year[num.age.min$value > high.rec]))
  low.rec.years <- as.vector(na.omit(num.age.min$Year[num.age.min$value < low.rec]))
  # Set up the full abundance matrix 
  full.abund <- abund
  print(paste0("Stock ", i , ' high recruit years include ', length(c(low.rec.years,high.rec.years)), ' years'))
  # If we need to imput some data run this loop for natural mortality
  if(minage == 0) full.abund <- abund
  

  if(minage > 0)
  {
    yrs <- sort(unique((nm.tmp$Year)))
    nm.res <- NULL
    # These already have NM estimates at 0 so don't need to do them...
    if(!i %in% c("ICES-WGCSE_CS7e-k_Gadus_morhua","ICES-WGCSE_ROCK6b_Melanogrammus_aeglefinus",
                 "ICES-WGHANSA_SP8abd_Sardina _pilchardus","ICES-WGWIDE_NEA 1,2,5,4a,14a_clupea_ harengus",
                 "ICES-WGWIDE_NEA 1-9,12,14_Micromesistius_poutassou"))
    {
      # Just use the mean mortality of the youngest age class we have information for
      nm.use <- mean(nm.tmp$NM[nm.tmp$age==minage],na.rm=T)
      # Take the average natural mortality of the youngest age class with an m and use that
      # This avoids really blowing up the abundance in the younger age classes which can get a bit squirrly
      # nm.high.rec <- 0.5*(min(nm.tmp$NM[nm.tmp$age==minage],na.rm=T))
      # nm.low.rec <-  1.5*(max(nm.tmp$NM[nm.tmp$age==minage],na.rm=T))
      # Start by filling in everything...
      nm.tmp$NM[is.na(nm.tmp$NM)] <- nm.use
      nm.tmp <- nm.tmp[nm.tmp$age %in% 0:maxage,]
      # Now we need to fill in the 'special' cohorts that were really big (low m) or really small (high m)
      # for(y in length(yrs):1)
      # {
      #   if(yrs[y] %in% c(high.rec.years,low.rec.years))
      #   {
      #     if(yrs[y] %in% high.rec.years) nm.pick <- nm.high.rec
      #     if(yrs[y] %in% low.rec.years) nm.pick <- nm.low.rec
      #     for(a in minage:1) nm.tmp$NM[nm.tmp$Year == (yrs[y]-a) & nm.tmp$age == minage-a] <- nm.pick
      # }} #Close the if and for loops
      # Pointless rename...
    } #end the skip the stocks with nm at 0 if
      nat.mort <- nm.tmp
      
  # Now do the same loopiness for abundance
    for(y in length(yrs):2)
    {
      # The minage of the natural mortality is different from minage of the abundance, annoyingly for this stock...
      if(i == "ICES-AFWG_NEA1-2_Gadus_morhua") minage <- 3
      if(i == "ICES-NWWG_ICE-Summer_Clupea_harengus") minage <- 3

           # The lowest minage =4, This goes first since we go backwards, this gets us age 3 in year 3
           if(minage ==4) 
           {
               four.abund <- full.abund %>% dplyr::filter(Year == yrs[y], age == 4) %>% dplyr::pull(Num)
               nm.four <- 1-exp(-nat.mort[nat.mort$Year ==yrs[y]-1,][4,]$NM) 
               full.abund[full.abund$Year ==yrs[y]-1,][4,]$Num <- four.abund/(1-nm.four)
             #}# end my 2:0
           } # end if minage ==4
           
            # The minage =3 scenario, goes after 4...
           if(minage >=3)
           {
             # for(my in 0:1)
             # {
               three.abund <- full.abund %>% dplyr::filter(Year == yrs[y], age == 3) %>% dplyr::pull(Num)
               nm.three <- 1-exp(-nat.mort[nat.mort$Year ==yrs[y]-1,][3,]$NM) 
               full.abund[full.abund$Year ==yrs[y]-1,][3,]$Num <- three.abund/(1-nm.three)
             #} # end my 1:0
           } # end if(minage ==2)
                      
           # The minage =2 scenario, this goes last
           if(minage >=2)
           {
             two.abund <- full.abund %>% dplyr::filter(Year == yrs[y], age == 2) %>% dplyr::pull(Num)
             nm.two <- 1-exp(-nat.mort[nat.mort$Year ==yrs[y]-1,][2,]$NM) 
             full.abund[full.abund$Year ==yrs[y]-1,][2,]$Num <- two.abund/(1-nm.two)
           } # end if(minage ==2)
           
           if(minage >=1)
           {
             one.abund <- full.abund %>% dplyr::filter(Year == yrs[y], age == 1) %>% dplyr::pull(Num)
             nm.one <- 1-exp(-nat.mort[nat.mort$Year ==yrs[y]-1,][1,]$NM) 
             full.abund[full.abund$Year ==yrs[y]-1,][1,]$Num <- one.abund/(1-nm.one)
           } # end if(minage ==2)
      
         } # The annoying if to fill in rest of the first few years.
  } # end if minage > 0
 
  # We won't have a weight at age for the young ages, which is fine since we only need that for SSB
  weight.age <- ASR_sub %>% dplyr::filter(type=="WA") %>% dplyr::rename(WA=value) %>% dplyr::select(-type)
  removals <- ASR_sub %>% dplyr::filter(type=="Catch") %>% dplyr::rename(Catch=value) %>% dplyr::select(-type)
  # Fill the leading NAs with 0s now...
  if(minage > 0) 
  {
    weight.age$WA[weight.age$age %in% 0:(minage-1)] <- 0
    removals$Catch[removals$age %in% 0:(minage-1)] <- 0
  }
 # if(i=="ICES-WGBFAS_BS 22-32_Sprattus_sprattus") removals$Catch <- removals$Catch/1000
  
  data <- age.mat %>%
    full_join(nat.mort) %>%
    #full_join(abund) %>%
    full_join(full.abund) %>%
    full_join(weight.age) %>%
    full_join(removals)

  # Nice way to toss NAs!
  data$available <- apply(is.na(data[, c("AM", "Num", "WA")]), 1, function(x) all(!x==T))
  data <- data[data$available==T,]
  # And then toss the years we don't have 0 data for Numbers in the 0 age class
  toss.years <- data %>% dplyr::group_by(Year) %>% dplyr::reframe(bad.years = which(min(age)>0))
  data <- data[!data$Year %in% toss.years$Year,]
  
  # Tidy up the data for input...
  data$prop.nat.mort <- 1-exp(-data$NM)
  #prop.nat.mort[,-which(names(prop.nat.mort) %in% c("Year", "Stock", "type"))] <- 1-exp(-prop.nat.mort[,-which(names(prop.nat.mort) %in% c("Year", "Stock", "type"))])

  rem <- data %>% dplyr::group_by(Year,.drop=F) %>% dplyr::summarize(rem=sum(Catch,na.rm=T)) #%>% dplyr::pull(rem)
  
  missing_rem<- NULL
  if(any(is.na(rem$rem))) 
  {
    missing_rem <- unique(data$Year)[which(is.na(rem$rem))]
    rem$rem[is.na(rem$rem)] <- median(rem$rem, na.rm=T)
  }
  
  #rowSums(removals[,-which(names(removals) %in% c("Year", "Stock", "type"))], na.rm=T)
  years <- data %>% dplyr::pull(Year) %>% unique() %>% sort()

  N.end <- sum(data[data$Year==max(years),]$Num)
  all.abund <- data %>% dplyr::group_by(Year) %>% dplyr::summarize(vpa=sum(Num,na.rm=T)) %>% pull(vpa)
  vpa.abund <- data %>% dplyr::group_by(Year) %>% dplyr::filter(age %in% minage:maxage) %>% dplyr::summarize(vpa=sum(Num,na.rm=T)) %>% pull(vpa)
  # The real mx matrix, recruits produced per individual in each age class... Not perfect as I need to offset recruits/ssb, but close enough for the moment..
 
  #recruits
  annual <- data.frame(Year=data$Year[data$age==0], recruits=data$Num[data$age==0])
  #ssn
  data$ssn <- data$Num * data$AM
  #ssb
  data$ssb <- data$ssn * data$WA #I need to figure out how to line this up with the number of recruits for the right years in the data object.... got it right for the overall r.p.ssb below.
  #tot.ssb
  annual <- data %>% group_by(Year) %>% summarize(tot.ssb = sum(ssb)) %>% left_join(annual)
  
  #tst <- data %>% group_by(Year) %>% summarize(tot.ssn = sum(ssn)) %>% left_join(annual)

  #r.p.ssb So we are assuming the SSB in year X produces the observed recruits in year X
  annual$r.p.ssb <- annual$recruits/annual$tot.ssb
  # recs.per.age
  data <- left_join(data, annual)
  # So I need to make an offset SSB in the 'data' object to line up with the correct r.p.ssb field.  This is probably gonna suck...
  # tmp <- NULL
  # for(j in 1:length(years))
  # {
  #   tst <- data %>% dplyr::filter(Year == years[j]) %>% dplyr::select(ssb,ssn,Year,age)
  #   tst$Year <- tst$Year + minage
  #   names(tst) <- c("ssb.offset","ssn.offset","Year","age")
  #   tmp[[j]] <- tst
  # }
  # Unpack the list
  #@ssb.off <- do.call('rbind',tmp)
  # And merge it with the data object
  #data <- left_join(data,ssb.off,by=c("Year","age"))
  data$recs.per.age <- data$ssb*data$r.p.ssb
  # mx
  # Some of the stocks are just the males and females, so these are already half the population.  Probably can just not include the male stocks in the end.
  # The demographic models are 'female' only, so we'd want to divide the number of recruits by 2 and the SSN by 2, but that just cancels out
  # so there is no need to make the mom adjustment.
  data$mx <- data$recs.per.age/data$ssn # if(grepl("males",i))
  # if(!grepl("males",i))data$mx <- data$recs.per.age/data$ssn/2 # Moms only! 
  data$mx[is.nan(data$mx)] <- 0 # if we don't have any spawners in an age class in a year their fecundity is 0
  # Now for the very high recruitment years allow for a small amount of recruitment (20% of the lowest age) in the age classes after year 0....
  
  # if(length(high.rec.years) > 0)
  # {
  #   for(y in high.rec.years)
  #   {
  #     tmp <- data$AM[data$Year == y]
  #     am.fill <- which(tmp ==0) 
  #     if(length(am.fill) > 1) data$mx[data$Year == y-1][am.fill[-1]] <- 0.2*min(data$mx[data$Year == y & data$mx > 0],na.rm=T)
  #   }
  # }
  
  age.mat <- data %>% dplyr::select("Year", "age", "AM") %>% pivot_wider(names_from=age, values_from = AM) %>% dplyr::select(-Year)
  prop.nat.mort <- data %>% dplyr::select("Year", "age", "prop.nat.mort") %>% pivot_wider(names_from=age, values_from = prop.nat.mort) %>% dplyr::select(-Year) %>% as.data.frame
  weight.age <- data %>% dplyr::select("Year", "age", "WA") %>% pivot_wider(names_from=age, values_from = WA) %>% dplyr::select(-Year)
  mx <- data %>% dplyr::select("Year", "age", "mx") %>% pivot_wider(names_from=age, values_from = mx) %>% dplyr::select(-Year) %>% as.data.frame()
  abund.age <- data %>% dplyr::select("Year", "age", "Num") %>% pivot_wider(names_from=age, values_from = Num) %>% dplyr::select(-Year) %>% as.data.frame()
  # Now we can save out the catch and get an instantaneous F
  data$Catch[is.na(data$Catch)] <- 0
  data$Exp <- data$Catch/data$Num
  # If it is exactly 1 that leads to an Inf, which is annoying, so make it 1.1 and fix it with the rest below
  data$Exp[data$Exp == 1] <- 1.1
  # And make this an F
  data$Fs <- -log(1-data$Exp)
  if(any(is.na(data$Fs)))
  {
    fixers <- which(is.na(data$Fs))
    print(paste0("Had to replace ",length(fixers), ' exploitation rates for stock ',i))
    for(f in fixers)
    {
      yr <- data$Year[f]
      fs <- max(data$Fs[data$Year == yr],na.rm=T)
      data$Fs[f] <- fs
      data$Exp[f] <- 1-exp(-fs)
    }
  }
  
  full.rems <- data %>% dplyr::select("Year", "age", "Catch") %>% pivot_wider(names_from=age, values_from = Catch) %>% dplyr::select(-Year)
  full.Fs <-  data %>% dplyr::select("Year", "age", "Fs") %>% pivot_wider(names_from=age, values_from = Fs) %>% dplyr::select(-Year)
  
  
  if(i == "DFO_2J3KL_Gadus_morhua")
  {
    age.mat[,10:12] <- 1
    prop.nat.mort[,10:12] <- prop.nat.mort[,9]
    weight.age[12:14,11:12] <- weight.age[12:14,10]
    weight.age[15,12] <- weight.age[15,11]
    mx[12:14,11:12] <- mx[12:14,10]
    mx[15,12] <- mx[15,11]
    full.Fs[12:14,11:12] <- full.Fs[12:14,10]
    full.Fs[15,12] <- full.Fs[15,11]
    abund.age[12:14,11:12] <- abund.age[12:14,10]
    abund.age[15,12] <- abund.age[15,11]
    # I could calculate, but this will get us to the same place...
    full.rems[12:14,11:12] <- full.rems[12:14,10]
    full.rems[15,12] <- full.rems[15,11]
  }
  
  if(i == "DFO_4T-Spring_Clupea_harengus")
  {
    age.mat[6:7,12] <- 1
    prop.nat.mort[6:7,12] <- prop.nat.mort[6:7,11]
    weight.age[6:7,12] <- weight.age[6:7,11]
    mx[6:7,12] <- mx[6:7,11]
    full.Fs[6:7,12] <- full.Fs[6:7,11]
    abund.age[6:7,12] <- abund.age[6:7,11]
    full.rems[6:7,12] <- full.rems[6:7,11]
  }
  
  if(i == "ICES-HAWG_CS 6a- 7b-7c_Clupea_harengus") 
  {
    age.mat[30,9] <- 1
    prop.nat.mort[30,9] <- prop.nat.mort[30,8]
    weight.age[30,9] <- weight.age[29,9]
    mx[30,9] <- mx[30,8]
    full.Fs[30,9] <- full.Fs[30,8]
    abund.age[30,9] <- abund.age[30,8]
    full.rems[30,9] <- full.rems[30,8]
  }
  
  if(i == "ICES-WGCSE_IS6a-7b-7j_Dicentrarchus _labrax")
  {
    age.mat[c(14,27,40),7] <- age.mat[1,7]
    prop.nat.mort[c(14,27,40),7] <- prop.nat.mort[1,7]
    weight.age[c(14,27,40),7] <- weight.age[c(13,26,39),7]
    mx[c(14,27,40),7] <- mx[c(14,27,40),6]
    full.Fs[c(14,27,40),7] <- full.Fs[c(14,27,40),6]
    abund.age[c(14,27,40),7] <- abund.age[c(14,27,40),6]
    full.rems[c(14,27,40),7] <- full.rems[c(14,27,40),6]
  }
  # Clear out some 0's...
  if( i == "AFSC_EEBSAI_Limanda_aspera")
  {
    mx[4,19] <- mean(unlist(mx[4,c(18,20)]))
    mx[c(5,7),20] <- mx[c(5,7),19]
    mx[1:6,21] <- mx[1:6,20] 
  }
  # For the years of mx without SSB info to inform them
  # if(minage >0 ) 
  # {
  #   mx.fill <- as.data.frame(matrix(rep(colMeans(mx,na.rm=T),minage),nrow=minage,byrow=T),colnames = names(mx))
  #   names(mx) <- names(mx.fill)
  #  # mx <- rbind(mx[(minage+1):nrow(mx),],mx.fill) # or is it
  #   mx <- rbind(mx.fill,mx[(minage+1):nrow(mx),]) # I think this is right!
  # }
  years.tmp[[i]] <- years
  pnm.tmp[[i]] <- prop.nat.mort
  waa.tmp[[i]] <- weight.age
  ages.tmp[[i]] <- minage:maxage
  rem.tmp[[i]] <- rem
  mx.tmp[[i]] <- mx
  NE.tmp[[i]] <- N.end
  vpa.tmp[[i]] <- vpa.abund
  all.abund.tmp[[i]] <- all.abund
  full.abund.tmp[[i]] <- abund.age
  am.tmp[[i]] <- age.mat
  mr.tmp[[i]] <- missing_rem
  fs.tmp[[i]] <- full.Fs
  full.rem.tmp[[i]] <- full.rems
} #end input data loop

save(years.tmp,pnm.tmp,waa.tmp,ages.tmp,rem.tmp,mx.tmp,NE.tmp,vpa.tmp,mr.tmp,am.tmp,Stocks,ASR_stocks,ASR_long,all.abund.tmp,full.abund.tmp,fs.tmp,full.rem.tmp,file =  paste0(loc,"/Results/model_inputs_all_ages.Rdata"))

```

 
So now I can try to do some tuning, both forwards and backwards, lets see what we get from that...

```{r tunes}


########################## Now run the tuning sims
#


load(file = paste0(loc,"/Results/model_inputs_all_ages.Rdata"))

for.tune.all.res <- NULL
for.tune.summary <- NULL
for(i in Stocks)
{
  years <- years.tmp[[i]]
  prop.nat.mort <- pnm.tmp[[i]] 
  #rem <- rem.tmp[[i]] 
  mx <- mx.tmp[[i]] 
  N.end <- NE.tmp[[i]] 
  ages <- ages.tmp[[i]]
  vpa.abund <- vpa.tmp[[i]] 
  all.abund <- all.abund.tmp[[i]]
  fs <-fs.tmp[[i]]
  full.rem <- full.rem.tmp[[i]]
  full.abund <- full.abund.tmp[[i]]
  #all.abund <- full.abund.tmp[[i]]
  #N.end <- vpa.abund[length(vpa.abund)]
  #Pick your step size
  ss.size <- 0.01
  sensistive.stocks <- c("ICES-WGNSSK_NS 4-3aN_Trisopterus_esmarkii",
                          "ICES-HAWG_NS_Ammodytes_dubius",
                          "DFO_2J3KL_Gadus_morhua",
                          "DFO_3Pn-4RS_Gadus_morhua",
                          "DFO_4T-4VN_Gadus_morhua",
                          "ICES-WGCSE_IS7a_Gadus_morhua",
                          "ICES-WGCSE_CS7a_Merlangius_merlangus",
                          "ICES-WGNSSK_NS 4-7d,20_Gadus_morhua",
                          "ICES-WGNSSK_NS  4-6a-20_Melanogrammus_aeglefinus",
                          "ICES-WGHANSA_SP8abd_Sardina _pilchardus",
                          "ICES-WGNSSK_NS 4-7d_Merlangius_merlangus",
                          "NEFSC-GARMIII_SNE- MA_Limanda_ferruginea",
                          "NEFSC-GARMIII_MA_Paralichthys_dentatus",
                          "ICES-WGCSE_CS7e-k_Gadus_morhua",
                          "DFO_4T_Scomber_scombrus",
                          "ICES-WGCSE_CS27.6a_Merlangius_merlangus",
                          "ICES-WGBFAS_BS 22-32_Sprattus_sprattus",
                           "AFSC_GOA_Theragra_chalcogramma")
  
  if(i %in% sensistive.stocks) ss.size = ss.size/10

   N.start <- all.abund[1]
   print(i)
   # The fecundities are 
   fast.for.tune <- fast.tunes(years,
                           tuner='fec_nm',
                           step.size = ss.size, 
                           abund.ts = all.abund,
                           ages=ages,
                           nm = -(log(1-prop.nat.mort)),
                           fecund = mx,
                           fm = fs,
                           abund.age = full.abund, 
                           catch.age = full.rem, 
                           N.init = N.start,
                           direction= 'forwards'
                           )
   
   for.tune.all.res[[i]] <- fast.for.tune
   for.tune.tmp <- data.frame(fast.for.tune$res,Stock = i)
   for.tune.summary[[i]] <- for.tune.tmp
   
   N.end <- all.abund[length(all.abund)]
   
 
   
}





#DFO_2J3KL_Gadus_morhua -27.7984654 2.815738e+08
#ICES-WGCSE_IS6a-7b-7j_Dicentrarchus _labrax -21.6050608
# ICES-WGCSE_IS6a-7b-7j_Dicentrarchus _labrax Lotka error
# ICES-HAWG_CS 6a- 7b-7c_Clupea_harengus # lotka error


#saveRDS(for.tune.summary,"D:/Github/ICM/Results/forwards_fully_tuned_summary_z.Rds")
#saveRDS(for.tune.all.res,"D:/Github/ICM/Results/forwards_fully_tuned_all_res_z.Rds")
# saveRDS(for.tune.summary,"D:/Github/ICM/Results/forwards_fully_tuned_summary_nm.Rds")
# saveRDS(for.tune.all.res,"D:/Github/ICM/Results/forwards_fully_tuned_all_res_nm.Rds")
#saveRDS(for.tune.summary,"D:/Github/ICM/Results/forwards_fully_tuned_summary_fm.Rds")
#saveRDS(for.tune.all.res,"D:/Github/ICM/Results/forwards_fully_tuned_all_res_fm.Rds")
saveRDS(for.tune.summary,"D:/Github/ICM/Results/forwards_fully_tuned_summary_fec_nm.Rds")
saveRDS(for.tune.all.res,"D:/Github/ICM/Results/forwards_fully_tuned_all_res_fec_nm.Rds")
# 



```

```{r paper-other-metrics-and-metadata}

# We are now looking at everything, lifetime reproductive success
model <- "fec_nm"
for.tune.summary <- readRDS(paste0("D:/Github/ICM/Results/forwards_fully_tuned_summary_",model,".Rds"))
for.tune.all <- readRDS(paste0("D:/Github/ICM/Results/forwards_fully_tuned_all_res_",model,".Rds"))


load(file =  paste0(loc,"/Results/model_inputs_all_ages.Rdata"))
# Get the stocks...
Stocks <- names(for.tune.summary)
n.stocks <- length(Stocks)


############ Meta data and clean up, could be it's own chunk really, but it's really fast, so meh...

#  A quick way to get the other potentially interesting info for the stock...
drop <- which(names(ASR_long) %in% c("Year","type","age","value"))
meta <- NULL
for(i in Stocks) meta[[i]] <- ASR_long[ASR_long$Stock == i,-drop][1,]
meta <- do.call('rbind',meta)

# First making a meta data object and adding a bunch of columns to it... very messy!!
meta$Species[meta$Species == ' harengus']  <- "harengus"
meta$Species[meta$Species == "Aeglefinus"] <- "aeglefinus"
meta$Species[meta$Species == "Solea"] <- "solea"
meta$Genus[meta$Genus == " Hippoglossoides"] <- "Hippoglossoides"
meta$G.short <- toupper(paste0(substr(meta$Genus,1,1),"."))
meta$G.Species <- paste0(meta$G.short," ",meta$Species)
# Simplified Management
meta$Manage.short <- meta$Management
meta$Manage.short[grep("TRAC",meta$Management)] <- "DFO-TRAC"
meta$Manage.short[grep("DFO",meta$Management)] <- "DFO-TRAC"
meta$Manage.short[grep("NEFSC",meta$Management)] <- "NEFSC"
meta$Manage.short[grep("ICES",meta$Management)] <- "ICES"
     
# The 3 pieces of the ocean
meta$LME <- "NW Atlantic"
meta$LME[meta$Management == "AFSC"] <- "Pacific (Alaska)"
meta$LME[grepl("ICES",meta$Management)] <- "NE Atlantic"
# Some other Area summaries
meta$Area.broad <- meta$Area
meta$Area.long <- meta$Area
meta$Area.narrow <- "" # Leave this blank if not needed
     
meta$Area.broad[grep("NS",meta$Area)] <- "NS"
meta$Area.long[grep("NS",meta$Area)] <- "North Sea"
meta$Area.broad[grep("CS",meta$Area)] <- "CS"
meta$Area.long[grep("CS",meta$Area)] <- "Celtic Sea"
meta$Area.broad[grep("ROCK6b",meta$Area)] <- "CS"
meta$Area.long[grep("ROCK6b",meta$Area)] <- "Celtic Sea Rockall"
meta$Area.broad[grep("IS",meta$Area)] <- "IS"
meta$Area.long[grep("IS",meta$Area)] <- "Irish Sea"
meta$Area.broad[grep("BS",meta$Area)] <- "BS"
meta$Area.long[grep("BS",meta$Area)] <- "Baltic Sea"
meta$Area.broad[grep("NEA",meta$Area)] <- "NEA"
meta$Area.long[grep("NEA",meta$Area)] <- "NE Arctic"
meta$Area.broad[grep("B28.1",meta$Area)] <- "BS"
meta$Area.long[grep("B28.1",meta$Area)] <- "Baltic Sea"
meta$Area.broad[grep("SP8abd",meta$Area)] <- "BoB"
meta$Area.long[grep("SP8abd",meta$Area)] <- "Bay of Biscay"
meta$Area.broad[grep("FA",meta$Area)] <- "I-F"
meta$Area.broad[grep("ICE",meta$Area)] <- "I-F"
meta$Area.long[grep("FA",meta$Area)] <- "Faroes"
meta$Area.long[grep("ICE",meta$Area)] <- "Iceland"

meta$Area.broad[grep("GOM",meta$Area)] <- "GOM-GB"
meta$Area.long[grep("GOM",meta$Area)] <- "Gulf of Maine"
meta$Area.broad[grep("GB",meta$Area)] <- "GOM-GB"
meta$Area.long[grep("GB",meta$Area)] <- "Georges Bank"
meta$Area.broad[grep("5Y",meta$Area)] <- "GOM-GB"
meta$Area.long[grep("5Y",meta$Area)] <- "NAFO 5Y"
meta$Area.broad[grep("5Z",meta$Area)] <- "GOM-GB"
meta$Area.long[grep("5Z",meta$Area)] <- "NAFO 5Z"
meta$Area.broad[grep("USATL",meta$Area)] <- "GOM-GB" # The fishery is broader than just GOM, but it does also include it.
meta$Area.long[grep("USATL",meta$Area)] <- "US Atlantic" # The fishery is broader than just GOM, but it does also include it.
meta$Area.broad[grep("NWA",meta$Area)] <- "GOM-GB" # Mackerel... so that definition is a bit narrow....
meta$Area.long[grep("NWA",meta$Area)] <- "US Atlantic" # Mackerel... so that definition is a bit narrow....
#meta$Area1[grep("SNE- MA",meta$Area)] <- "GOM-GB" # YT in US, so no GB so that definition is a bit narrow....
meta$Area.broad[grep("MA",meta$Area)] <- "GOM-GB" # YT  and summer flounder in US, so no GB so that definition is a bit narrow....
meta$Area.long[grep("MA",meta$Area)] <- "Gulf of Maine" # YT  and summer flounder in US, so no GB so that definition is a bit narrow....
meta$Area.broad[grep("BSAI",meta$Area)] <- "BSAI"
meta$Area.broad[grep("4T",meta$Area)] <- "GSL"
meta$Area.long[grep("4T",meta$Area)] <- "NAFO 4T"
meta$Area.broad[grep("2J3",meta$Area)] <- "NFLD"
meta$Area.long[grep("2J3",meta$Area)] <- "NFLD"
meta$Area.broad[grep("3Pn-4RS",meta$Area)] <- "NFLD"
meta$Area.long[grep("3Pn-4RS",meta$Area)] <- "NFLD"
meta$Area.long[grep("GOA",meta$Area)] <- "Gulf of Alaska"
meta$Area.long[grep("AI",meta$Area)] <- "Aleutian Islands"
meta$Area.long[grep("ESB",meta$Area)] <- "Bering Sea"
meta$Area.long[grep("BSAI",meta$Area)] <- "Bering Sea & AI"
meta$Area[grep("BASI-Females",meta$Area)] <- "BSAI-Females"
meta$Area.long[grep("BSAI-Females",meta$Area)] <- "Bering Sea & AI"
meta$Area.narrow[meta$Stock == "ICES-NWWG_FA5b_Pollachius_virens"] <- "5b"
meta$Area.narrow[meta$Stock == "ICES-NWWG_FA5a_Pollachius_virens"] <- "5a"
meta$Area.narrow[meta$Stock == "ICES-WGNSSK_NS4 _Solea_solea"] <- "4"
meta$Area.narrow[meta$Stock == "ICES-WGNSSK_NS 7d._Solea_solea"] <- "7d"
meta$Area.narrow[meta$Stock == "ICES-WGBFAS_NS IIIa 22-24_Solea_Solea"] <- "22-24"
meta$Area.narrow[meta$Stock == "ICES-WGNSSK_NS 7d_Pleuronectes_platessa"] <- "7d"
meta$Area.narrow[meta$Stock == "ICES-WGNSSK_NS 4,20_Pleuronectes_platessa"] <- "4 20"
meta$Area.narrow[meta$Stock == "ICES-WGCSE_IS7e_Pleuronectes_platessa"] <- "7e"
meta$Area.narrow[meta$Stock == "ICES-WGCSE_IS27.7a_Pleuronectes_platessa"] <- "7a"
meta$Area.narrow[meta$Stock == "ICES-NWWG_FA5b_Melanogrammus_aeglefinus"] <- "5b"
meta$Area.narrow[meta$Stock == "ICES-NWWG_ICE5a_Melanogrammus_aeglefinus"] <- "5a"
meta$Area.narrow[meta$Stock == "ICES-WGBFAS_B28.1_Clupea_harengus"] <- "28"
meta$Area.narrow[meta$Stock == "ICES-WGBFAS_BS 25-29-32_Clupea_harengus" ] <- "25-32"
meta$Area.narrow[meta$Stock == "ICES-HAWG_WBS 22-24_Clupea_harengus"] <- "22-24"
meta$Area.narrow[meta$Stock == "DFO_4T-Fall_Clupea_harengus"] <- "Fall"
meta$Area.narrow[meta$Stock == "DFO_4T-Spring_Clupea_harengus"] <- "Spring"
meta$Area.narrow[meta$Stock == "ICES-WGCSE_CS27.6a_Merlangius_merlangus"] <- "27.6a"
meta$Area.narrow[meta$Stock == "ICES-WGCSE_CS7a_Merlangius_merlangus"] <- "7a"
meta$Area.narrow[meta$Stock == "ICES-NWWG_ICE5a_Gadus_morhua"] <- "5a"
meta$Area.narrow[meta$Stock == "ICES-NWWG_FAPL5b1_Gadus_morhua" ] <- "5b"
meta$Area.narrow[meta$Stock == "ICES-WGNSSK_NS 4-7d,20_Gadus_morhua"] <- "4-7 20"
meta$Area.narrow[meta$Stock == "ICES-WGCSE_NS6a_Gadus_morhua"] <- "6a"
meta$Area.narrow[meta$Stock == "DFO_2J3KL_Gadus_morhua"] <- "2J 3KL"
meta$Area.narrow[meta$Stock == "DFO_3Pn-4RS_Gadus_morhua"] <- "3Pn 4RS"
meta$Area.narrow[meta$Stock == "NEFSC-CERT-TRAC_GB _Gadus_morhua"] <- "East"

meta$Stock.short <- paste0(meta$Area.long," ",meta$Area.narrow," ",meta$G.short," ",meta$Species)
meta$Stock.no.species <- paste0(meta$Area.long," ",meta$Area.narrow)


for.tune.stocks <- NULL
fta <- NULL

# Going to rename these female stocks.
fem.names <- c("AFSC_BASI-Females_Pleuronectes_quadrituberculatus",
                  "AFSC_EEBSAI-Females_Lepidopsetta_polyxystra",
                  "AFSC_BSAI-females_Atheresthes_stomais")
fem.rename <- c("AFSC_BSAI_Pleuronectes_quadrituberculatus",
                  "AFSC_EEBSAI_Lepidopsetta_polyxystra",
                  "AFSC_BSAI_Atheresthes_stomais")
# Going to drop these stocks
dont <- paste(c("Mles","Males","COASTNOR"),collapse = "|")

meta.sub <- NULL
for(i in Stocks) 
{
  org.nam <- i
  tmp <- for.tune.summary[[org.nam]]
  new.stock.nam <- org.nam
  # Don't bother for these stocks...
  if(!grepl(dont,tmp$Stock[1]))
  {
    # Grab the metadata and add in some new useful things...
    meta.sub[[i]] <- meta[meta$Stock == org.nam,]
      
    # Rename the ladies
    if(tmp$Stock[1] == fem.names[1]) new.stock.nam <- tmp$Stock <- fem.rename[1]
    if(tmp$Stock[1] == fem.names[2]) new.stock.nam <- tmp$Stock <- fem.rename[2]
    if(tmp$Stock[1] == fem.names[3]) new.stock.nam <- tmp$Stock <- fem.rename[3]
    
    meta.sub[[i]]$Stock <- new.stock.nam
    tmp <- data.frame(tmp,meta.sub[[i]])
    # For tunes all
    fta[[new.stock.nam]] <- for.tune.all[[org.nam]]
    fta[[new.stock.nam]]$meta <- meta.sub[[i]]
    for.tune.stocks[[new.stock.nam]] <- tmp
  }# End skip stocks...
}
# Now unpack them...
for.tunes <- do.call("rbind",for.tune.stocks)
for.tune.all <- fta
meta.sub <- do.call("rbind",meta.sub)

######################### End Meta data and clean up #####################


# Now some summaries...

# Reset on the stocks...
Stocks <- sort(names(for.tune.all))
n.stocks <- length(Stocks)




# Doubling time, no fishing
dt.res <- NULL
n.dt.sims <- 2000 # Number of simulations...
n.years <- 100
for(i in Stocks)
{
  try <- for.tunes %>% dplyr::filter(Stock == i)
  meta.tmp <- meta.sub %>% dplyr::filter(Stock == i)
  double.time <- NA
  pop <- 1000
  tmp.res <- NULL
for(s in 1:n.dt.sims)
{
  tmp <- rep(0,n.years)
  
  for(y in 2:n.years)
  {
    lambda <- sample(na.omit(try$lambda),size=1)
    pop[y] <- lambda*pop[y-1]
    if(pop[y] >= 2*pop[1] & tmp[y] == 0) tmp[y:n.years] <- 1
  } # end the years loop
  tmp.res[[s]] <- data.frame(year =1:100,doubled = tmp,sim=s)
  } # end sim loop
  res.tmp <- do.call("rbind",tmp.res)
  
dt.res[[i]] <- data.frame(res.tmp,meta.tmp)

} # end Stocks loop

dub.time <- do.call("rbind",dt.res)

dub.time.summary <- dub.time %>% dplyr::group_by(Stock,year)  %>% dplyr::summarise(prop = sum(doubled)/n.dt.sims)
dub.time.summary <- left_join(dub.time.summary,meta.sub,by="Stock")

# Now to get generation lengths + reproductive rates....
# First I need to get the fecundity and natural mortalities by cohort instead of year.
res.fin <- NULL
res.year.fin <- NULL
res.lambda.fin <- NULL
for(i in Stocks)
{
  tst <- for.tune.all[[i]]
  meta.tmp <- tst$meta
  # Fishing mortality
  fm.org.tmp <- tst$fm.org
  fm.tmp <- tst$fm.opt
  # fecundity
  fec.tmp <- tst$fecund.opt
  fec.org.tmp <- tst$fecund.org
  # Natural mortality
  m.org.tmp <- exp(-tst$nm.org) # This is survivorship
  m.tmp <- exp(-tst$nm.opt) # This is survivorship
  # Total mortality
  z.tmp <- exp(-tst$z.opt) # This is survivorship
  z.org.tmp <- exp(-tst$nm.org -fm.org.tmp) # This is survivorship
  
  ages <- 0:(ncol(fec.tmp)-1)
  n.ages <- length(ages)
  years <- tst$res$year
  n.years <- length(years)
  # Now I need to grab the fecundities and nat morts by cohort
  if(n.years > n.ages)
  {
  res.cohort <- NULL
  res.year <- NULL
  res.lambda <- NULL
  for(y in 1:(n.years-n.ages+1))
  {
    count = 0
    fs <- NA
    # The lx is no fishing survivorship, zx I'm calling the survivorship including fishing
    lx <- lx.org <- lx.year <- zx <- zx.org <- zx.year <- 1
    fs.org <- NA
    
    for(a in 1:n.ages)
    {
    fs[a] <- fec.tmp[y+count,a]  
    fs.org[a] <- fec.org.tmp[y+count,a]  
    if(a > 1) 
    {
      # No fishing
      lx[a] <- lx[a-1] * m.tmp[y+count,a]  
      lx.org[a] <- lx.org[a-1]* m.org.tmp[y+count,a]  
      lx.year[a] <- lx.year[a-1] * m.tmp[y,a]
      # Including fishing
      zx[a] <- zx[a-1] * z.tmp[y+count,a]  
      zx.org[a] <- zx.org[a-1]* z.org.tmp[y+count,a]  
      zx.year[a] <- zx.year[a-1] * z.tmp[y,a]
    }  # end the a > 1 if
        count <- count + 1
    }# end the ages loop
        res.cohort[[y]] <- data.frame(mx.opt = fs,lx.opt = lx,mx.org = fs.org,lx.opt = lx,
                               mx.lx.opt = fs*lx,mx.lx.org = fs.org*lx.org,
                               x.mx.lx.opt = fs*lx*ages,x.mx.lx.org = fs.org*lx.org*ages,
                               zx.opt = zx,zx.opt = zx,
                               mx.zx.opt = fs*zx,mx.zx.org = fs.org*zx.org,
                               x.mx.zx.opt = fs*zx*ages,x.mx.zx.org = fs.org*zx.org*ages,
                               cohort=years[y],age = ages,meta.tmp)
        
        res.year[[y]] <- data.frame(mx.opt = unlist(fec.tmp[y,]),lx.opt = lx.year,
                               mx.lx.opt = unlist(fec.tmp[y,])*lx.year,
                               x.mx.lx.opt = unlist(fec.tmp[y,])*lx.year*ages,
                               zx.opt = zx.year,
                               mx.zx.opt = unlist(fec.tmp[y,])*lx.year,
                               x.mx.zx.opt = unlist(fec.tmp[y,])*lx.year*ages,
                               age = ages,year=years[y],meta.tmp)

  } # end the years loop

# Do a years loop to get lambda with no fishing for each year, rather than by cohort...
  for(yy in 1:n.years)
  {
    nm <- as.numeric(tst$nm.opt[yy,])
    z <- as.numeric(tst$z.opt[yy,])
    fec <- as.numeric(tst$fecund.opt[yy,])
    nm.init <- as.numeric(tst$nm.org[yy,])
    fec.init <- as.numeric(tst$fecund.org[yy,])
    z.init <- as.numeric(tst$z.org[yy,])
    lam.no.fish <- exp(simple.lotka.r(Z = nm,fecund = fec,ages=ages)$res)
    lam.fish <- exp(simple.lotka.r(Z = z,fecund = fec,ages=ages)$res)
    lam.org.no.fish <- exp(simple.lotka.r(Z = nm.init,fecund = fec.init,ages=ages)$res)
    lam.org.fish <- exp(simple.lotka.r(Z =  z.init,fecund = fec.init,ages=ages)$res)
    
    # Now summarize these
    res.lambda[[yy]] <-  data.frame(lam.no.fish = lam.no.fish,lam.fish = lam.fish,
                                    lam.org.no.fish = lam.org.no.fish,
                                    lam.org.fish = lam.org.fish,
                                    year=years[yy],meta.tmp)
  } # End the yy loop to get the lambdas...
# unpack it...
res.fin[[i]] <- do.call('rbind',res.cohort)
res.year.fin[[i]] <- do.call('rbind',res.year)
res.lambda.fin[[i]] <-  do.call('rbind',res.lambda)
}  # end if to make sure we have enough data to get the cohort estimates.

}# end the stock loop

res.cohort.final <- do.call('rbind',res.fin)
res.year.final <- do.call('rbind',res.year.fin)
res.lambda.final <- do.call('rbind',res.lambda.fin)

pop.dam <- res.cohort.final %>% dplyr::group_by(cohort,Stock) %>% dplyr::summarise(gen.len.opt = sum(x.mx.lx.opt)/sum(mx.lx.opt),
                                                                gen.len.org = sum(x.mx.lx.org)/sum(mx.lx.org),
                                                                R0.opt = sum(mx.lx.opt),R0.org = sum(mx.lx.org))
pop.dam <- left_join(pop.dam,meta.sub,by="Stock")

dub.time.summary <- data.frame(dub.time.summary)
pop.dam <- data.frame(pop.dam)
# saveRDS(pop.dam,paste0("D:/Github/ICM/Results/R0_and_gen_length_",model,".Rds"))
# saveRDS(dub.time.summary,paste0("D:/Github/ICM/Results/doubling_time_",model,".Rds"))
# saveRDS(for.tunes,paste0("D:/Github/ICM/Results/forward_tunes_for_figures_",model,".Rds"))
save(dub.time.summary,pop.dam,res.year.final,res.cohort.final,for.tunes,dub.time,for.tune.all,res.lambda.final,meta,meta.sub,
     file=paste0("D:/Github/ICM/Results/all_cleaned_forward_tune_summaries_",model,".Rdata"))

write.csv(meta.sub, "D:/Github/ICM/Data/metadata.csv")

```


```{r simp-figs}
theme_set(theme_few(base_size = 14))
model <- 'fec_nm'
load(file=paste0("D:/Github/ICM/Results/all_cleaned_forward_tune_summaries_",model,".Rdata"))
pop.dam <- data.frame(pop.dam)
six.species <- c('morhua','harengus','aeglefinus','virens','solea','platessa')
pop.dam.6 <- pop.dam %>% dplyr::filter(Species %in% six.species)
for.tunes.6 <- for.tunes %>% dplyr::filter(Species %in% six.species)
dub.time.6 <- dub.time.summary %>% dplyr::filter(Species %in% six.species)
res.lambda.final$decade <- floor(res.lambda.final$year/10)*10
res.lambda.final <- res.lambda.final %>% dplyr::group_by(Stock,decade) %>% dplyr::mutate(mn.lam = mean(lam.fish,na.rm=T),
                                                                                 med.lam = median(lam.fish,na.rm=T),
                                                                                 sd.lam = sd(lam.fish,na.rm=T))
res.lambda.final <- res.lambda.final %>% dplyr::group_by(Species,decade) %>% dplyr::mutate(lm.spec.mn = mean(mn.lam,na.rm=T))              
res.lambda.final <- res.lambda.final %>% dplyr::group_by(Stock) %>% 
                                            dplyr::mutate(lam.no.fish.mn = mean(lam.no.fish,na.rm=T),
                                                          lam.fish.mn = mean(lam.fish,na.rm=T),
                                                          lam.org.no.fish.mn = mean(lam.org.no.fish,na.rm=T),
                                                          lam.org.fish.mn = mean(lam.org.fish,na.rm=T),
                                                          lam.no.fish.med = median(lam.no.fish,na.rm=T),
                                                          lam.fish.med = median(lam.fish,na.rm=T),
                                                          lam.org.no.fish.med = median(lam.org.no.fish,na.rm=T),
                                                          lam.org.fish.med = median(lam.org.fish,na.rm=T),) %>% data.frame()

res.lambda.final.6 <- res.lambda.final %>% dplyr::filter(Species %in% six.species)
# Sort the data into a nice order...
res.lambda.final <- res.lambda.final %>% dplyr::arrange(Species,Area.broad) %>%
                                             dplyr::mutate(Stock.no.species = forcats::fct_inorder(factor(Stock.no.species, ordered=TRUE)))
res.lambda.final.6 <- res.lambda.final.6 %>% dplyr::arrange(Species,Area.broad) %>%
                                             dplyr::mutate(Stock.no.species = forcats::fct_inorder(factor(Stock.no.species, ordered=TRUE)))
dub.time <- dub.time %>% dplyr::arrange(LME) %>%
                             dplyr::mutate(Stock.no.species = forcats::fct_inorder(factor(Stock.no.species, ordered=TRUE)))

dub.time.summary <- dub.time.summary %>% dplyr::arrange(LME,Order,Species,Area.broad) %>%
                                         dplyr::mutate(Stock.short = forcats::fct_inorder(factor(Stock.short, ordered=TRUE)))

dub.time.6 <- dub.time.6 %>% dplyr::arrange(LME) %>%
                             dplyr::mutate(Stock.no.species = forcats::fct_inorder(factor(Stock.no.species, ordered=TRUE)))
pop.dam <- pop.dam %>% dplyr::arrange(Species,LME) %>%
                       dplyr::mutate(Stock = forcats::fct_inorder(factor(Stock, ordered=TRUE)))
pop.dam.6 <- pop.dam.6 %>% dplyr::arrange(LME,Area.broad) %>%
                       dplyr::mutate(Stock.no.species = forcats::fct_inorder(factor(Stock.no.species, ordered=TRUE)))
                            
# Lambda plots
              

# res.lambda.final.6 <- res.lambda.final.6 %>% dplyr::arrange(LME,Area.broad) %>%
#                                              dplyr::mutate(Stock.no.species = forcats::fct_inorder(factor(Stock.no.species, ordered=TRUE)))
            

################### Figures in main text################### Figures in main text################### Figures in main text################### 

#hmm <- merge(tst,res.lambda.final.6,by="Stock")
plot(res.lambda.final$lam.fish.med ~ res.lambda.final$lam.fish.mn)
# So this is lambda with fishing included
lambda.plt <- ggplot(res.lambda.final.6) + geom_boxplot(aes(y=lam.no.fish,x=Stock.no.species))  + 
                                           geom_point(aes(y=lam.no.fish.mn,x=Stock.no.species),color='blue',shape=8,fill='blue') +
                                           xlab("") + scale_y_log10("lambda",breaks = c(0.4,0.6,0.8,1,1.25,1.75,3,5,10)) + 
                                           geom_hline(yintercept = 1,linetype='dashed') +
                                           facet_wrap(~G.Species,scales='free')+
                                           theme(axis.text.x = element_text(angle =45,hjust=1),legend.position = 'none',
                                                 plot.margin = margin(0,0.5,0,0.5, "cm"),axis.title.y = element_text(margin = margin(r = 30)))

save_plot("D:/Github/ICM/Figures/tuned/lambda_no_fishing_6.png",lambda.plt,base_width = 12,base_height = 10)

# With fishing
lambda.plt.fish <- ggplot(res.lambda.final.6) + geom_boxplot(aes(y=lam.fish,x=Stock.no.species))  + 
                                           geom_point(aes(y=lam.fish.mn,x=Stock.no.species),color='blue',shape=8,fill='blue') +
                                           xlab("") + scale_y_log10("lambda",breaks = c(0.4,0.6,0.8,1,1.25,1.75,3,5,10)) + 
                                           geom_hline(yintercept = 1,linetype='dashed') +
                                           facet_wrap(~G.Species,scales='free')+
                                           theme(axis.text.x = element_text(angle =45,hjust=1),legend.position = 'none',
                                                 plot.margin = margin(0,0.5,0,0.5, "cm"),axis.title.y = element_text(margin = margin(r = 30)))


save_plot("D:/Github/ICM/Figures/tuned/lambda_with_fishing_6.png",lambda.plt.fish,base_width = 12,base_height = 10)


# Doubling Times

dub.heatmap.cod <- ggplot(dub.time.6 %>% dplyr::filter(G.Species == "G. morhua"), aes(x=year, y=Stock.no.species, fill= prop)) + xlab("") + ylab("")+                                     facet_wrap(~G.Species,nrow=3,scales='free_y',strip.position = "right") + 
                            geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + scale_x_continuous(labels=NULL) +
                            theme(legend.position = 'top',text = element_text(size=12),plot.margin = margin(0,0.5,0,0, "cm"),
                                  legend.key.width = unit(3,'cm'))

dub.heatmap.herring<- ggplot(dub.time.6 %>% dplyr::filter(G.Species == "C. harengus"), aes(x=year, y=Stock.no.species, fill= prop)) + 
                              xlab("") + ylab("")+                                    
                              facet_wrap(~G.Species,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                              geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
                              theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,0.4, "cm"))

dub.heatmap.haddock<- ggplot(dub.time.6 %>% dplyr::filter(G.Species == "M. aeglefinus"), aes(x=year, y=Stock.no.species, fill= prop)) + 
                              xlab("") + ylab("")+                                    
                              facet_wrap(~G.Species,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                              geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
                              theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,0.125, "cm"))

dub.heatmap.virens<- ggplot(dub.time.6 %>% dplyr::filter(G.Species == "P. virens"), aes(x=year, y=Stock.no.species, fill= prop)) + 
                              xlab("") + ylab("")+                                    
                              facet_wrap(~G.Species,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                              geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
                              theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,1.4, "cm"))

dub.heatmap.solea<- ggplot(dub.time.6 %>% dplyr::filter(G.Species == "S. solea"), aes(x=year, y=Stock.no.species, fill= prop)) + 
                              xlab("") + ylab("")+                                    
                              facet_wrap(~G.Species,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                              geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
                              theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,0.4, "cm"))

dub.heatmap.platessa<- ggplot(dub.time.6 %>% dplyr::filter(G.Species == "P. platessa"), aes(x=year, y=Stock.no.species, fill= prop)) + 
                              xlab("") + ylab("")+                                    
                              facet_wrap(~G.Species,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous() +
                              geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
                              theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,0.68, "cm"))



dub.heatmap.sp6 <- cowplot::plot_grid(dub.heatmap.cod,dub.heatmap.herring,dub.heatmap.haddock,
                                 dub.heatmap.virens, dub.heatmap.solea,dub.heatmap.platessa,nrow = 6,rel_heights = c(14,9,8,5,5,4))
dub.heatmap.sp6

save_plot("D:/Github/ICM/Figures/tuned/Doubling_time_heatmap_by_sp6.png",dub.heatmap.sp6,base_width = 20,base_height = 17)



# Generation length

gen.boxplt <- ggplot(pop.dam.6) +
                            geom_boxplot(aes(y=gen.len.opt,x=Stock.no.species))  + 
                            xlab("") + scale_y_continuous("Generation Length (years)",limits=c(0,13),breaks= seq(0,20,by=2)) +
                            facet_wrap(~G.Species,scales='free_x')+
                            theme(axis.text.x = element_text(angle =45,hjust=1),legend.position = 'none',plot.margin = margin(0,0.5,0,0.5, "cm"),
                                  axis.title.y = element_text(margin = margin(r = 30)))

save_plot("D:/Github/ICM/Figures/tuned/GL_boxplot_no_fish_6_species.png",gen.boxplt,base_width = 12,base_height = 10)

# Lifetime reproductive success (no fishing)


r0.boxplt <- ggplot(pop.dam.6) +
                            geom_boxplot(aes(y=R0.opt,x=Stock.no.species))  + 
                            xlab("") + scale_y_log10(name = "Lifetime Reproductive Output")+
                            geom_hline(yintercept = 1,linetype='dashed',color='blue')+
                            facet_wrap(~G.Species,scales = 'free')+
                            theme(axis.text.x = element_text(angle =45,hjust=1),legend.position = 'none',plot.margin = margin(0,0.5,0,0.5, "cm"),
                                  axis.title.y = element_text(margin = margin(r = 30)))

save_plot("D:/Github/ICM/Figures/tuned/R0_boxplot_no_fish_6_species.png",r0.boxplt,base_width = 12,base_height = 10)




################### Supplemental Figures################### Supplemental Figures################### Supplemental Figures################### Supplemental 

# Reorder the doubling time, either by Species and LME, or the other way around

dub.time.summary$Order.short <- "Gadi"
dub.time.summary$Order.short[dub.time.summary$Order == "Pleuronectiformes"] <- "Plero"
dub.time.summary$Order.short[dub.time.summary$Order == "Clupeiformes"] <- "Clupei"
dub.time.summary$Order.short[dub.time.summary$Order == "Scorpaeniformes "] <- "Scor"
dub.time.summary$Order.short[dub.time.summary$Order == "Scombriformes"] <- "Scomb"
dub.time.summary$Order.short[dub.time.summary$Order == "Perciformes"] <- "Perci"

dub.time.summary <- dub.time.summary %>%
                            dplyr::arrange(G.Species,LME,Area.broad) %>%
                            dplyr::mutate(Stock.short = forcats::fct_inorder(factor(Stock.short, ordered=TRUE)))
              
dub.heatmap.gad <- ggplot(dub.time.summary %>% dplyr::filter(Order == "Gadiformes"), aes(x=year, y=Stock.short, fill= prop)) + 
                            xlab("") + ylab("")+                                    
                            facet_wrap(~Order.short,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                            geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
                            theme(legend.position = 'top',text = element_text(size=12),plot.margin = margin(0,0.5,0,0.45, "cm"),
                                  legend.key.width = unit(3,'cm'))

dub.heatmap.pl <- ggplot(dub.time.summary %>% dplyr::filter(Order == "Pleuronectiformes"), aes(x=year, y=Stock.short, fill= prop)) + 
                            xlab("") + ylab("")+                                    
                            facet_wrap(~Order.short,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                            geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
                            theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,0, "cm"))

dub.heatmap.cl <- ggplot(dub.time.summary %>% dplyr::filter(Order == "Clupeiformes"), aes(x=year, y=Stock.short, fill= prop)) + 
                            xlab("") + ylab("")+
                            facet_wrap(~Order.short,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                            geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
                            theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,1.35, "cm"),
                                  legend.key.width = unit(3,'cm'))

dub.heatmap.per <- ggplot(dub.time.summary %>% dplyr::filter(Order == "Perciformes"), aes(x=year, y=Stock.short, fill= prop)) + 
                            xlab("") + ylab("")+
                            facet_wrap(~Order.short,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                            geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
                            theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,2, "cm"),
                                  legend.key.width = unit(3,'cm'))

dub.heatmap.scom <- ggplot(dub.time.summary %>% dplyr::filter(Order == "Scombriformes"), aes(x=year, y=Stock.short, fill= prop)) + 
                            xlab("") + ylab("")+
                            facet_wrap(~Order.short,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                            geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
                            theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,2.1, "cm"),
                                  legend.key.width = unit(3,'cm'))

dub.heatmap.scorp <- ggplot(dub.time.summary %>% dplyr::filter(Order %in% "Scorpaeniformes "), aes(x=year, y=Stock.short, fill= prop)) + 
                            xlab("") + ylab("")+
                            facet_wrap(~Order.short,nrow=3,scales='free_y',strip.position = "right") + 
                            geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
                            theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,0.5, "cm"),
                                  legend.key.width = unit(3,'cm'))



dub.heatmap <- cowplot::plot_grid(dub.heatmap.gad,dub.heatmap.pl,dub.heatmap.cl,dub.heatmap.per,dub.heatmap.scom,dub.heatmap.scorp,
                                  nrow = 6,rel_heights = c(39,20,11,4,3,3))
dub.heatmap

save_plot("D:/Github/ICM/Figures/tuned/Doubling_time_heatmap_by_order.png",dub.heatmap,base_width = 20,base_height = 20)

# Time series of lambdas....
col.try <- rep(rep(c("black","blue","orange",'firebrick2','lightgreen'),3),20)
#col.try <- rep(c(rep("black",3),rep("blue",3),rep('orange',3),rep('firebrick2',3),rep('lightgreen',3)),20)
pty <- rep(c(rep(21,5),rep(22,5),rep(23,5)),20)
#pty <- rep(rep(c(21:23),5),20)

lambda.ts.plt <- ggplot(res.lambda.final.6,aes(y=lam.fish,x=year,group=Stock.short,color=Stock.short,shape = Stock.short,fill = Stock.short)) +
                            geom_point(size=4) +
                            geom_smooth(method='gam',formula = y ~ s(x, bs = "cs", fx = TRUE, k = 5),se=F) + 
                            #scale_y_log10(name = "lambda") +
                            facet_wrap(~G.Species,scales='free_y') +
                            scale_color_manual(name = "Stock",values = col.try) + scale_shape_manual(name = "Stock",values = pty) +
                            scale_fill_manual(name = "Stock",values = col.try)+
                            guides(colour = guide_legend(ncol = 1))+
                            theme(axis.text.x = element_text(angle =45,hjust=1),legend.key.width = unit(5,'cm'))
#lambda.ts.plt
save_plot("D:/Github/ICM/Figures/tuned/lambda_timeseries_6.png",lambda.ts.plt,base_width = 12,base_height = 10)


lambda.dec.plt <- ggplot(res.lambda.final.6,aes(y=med.lam,x=as.factor(decade))) +
                            geom_boxplot() + scale_y_log10()+
                            xlab("Decade") + ylab("Lambda") + 
                            geom_point(aes(x=as.factor(decade),y=lm.spec.mn),color='blue',shape=8,fill='blue')+
                            #scale_x_continuous(breaks=seq(1940,2020,by=10))+
                            geom_hline(yintercept = 1,linetype='dashed') +
                            facet_wrap(~G.Species,scales='free_y') 
save_plot("D:/Github/ICM/Figures/tuned/lambda_by_decade_6.png",lambda.dec.plt,base_width = 12,base_height = 12)





gen.heatmap.ne <- ggplot(pop.dam %>% dplyr::filter(LME == "NE Atlantic"), aes(x=cohort, y=Stock.short, fill= gen.len.opt)) + 
                                              xlab("") + ylab("")+  
                                              facet_wrap(~LME,nrow=3,scales='free_y',strip.position = "right") + 
                                              geom_tile() + scale_fill_viridis(name = "Generation length (years)",discrete=FALSE) + 
                                              theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,0.9, "cm"))

gen.heatmap.nw <- ggplot(pop.dam %>% dplyr::filter(LME == "NW Atlantic"), aes(x=cohort, y=Stock.short, fill= gen.len.opt)) + xlab("") + ylab("")+                                    facet_wrap(~LME,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                            geom_tile() + scale_fill_viridis(name = "Generation length (years)",discrete=FALSE) + 
                            theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,1.22, "cm"))

gen.heatmap.pac <- ggplot(pop.dam %>% dplyr::filter(LME == "Pacific (Alaska)"), aes(x=cohort, y=Stock.short, fill= gen.len.opt)) + xlab("") + ylab("")+
                            facet_wrap(~LME,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                            geom_tile() + scale_fill_viridis(name = "Generation length (years)",discrete=FALSE) + 
                            theme(legend.position = 'top',text = element_text(size=12),plot.margin = margin(0,0.5,0,0, "cm"),
                                  legend.key.width = unit(3,'cm'))

gen.heatmap <- cowplot::plot_grid(gen.heatmap.pac,gen.heatmap.nw,gen.heatmap.ne,nrow = 3,rel_heights = c(3,4,10))
gen.heatmap

save_plot("D:/Github/ICM/Figures/tuned/gen_heatmap.png",gen.heatmap,base_width = 20,base_height = 17)

r0.heatmap.ne <- ggplot(pop.dam %>% dplyr::filter(LME == "NE Atlantic"), aes(x=cohort, y=Stock.short, fill= R0.opt)) + 
                                    xlab("") + ylab("")+
                                    facet_wrap(~LME,nrow=3,scales='free_y',strip.position = "right") + 
                                    geom_tile() + 
                                     scale_fill_viridis(name = "Lifetime reproductive success", breaks = c(0.4,1,2,4,10,20,40,100,200,400),
                                                        discrete=FALSE,trans='log') + 
                                    theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,0.9, "cm"))

r0.heatmap.nw <- ggplot(pop.dam %>% dplyr::filter(LME == "NW Atlantic"), aes(x=cohort, y=Stock.short, fill= R0.opt)) + 
                                    xlab("") + ylab("")+
                                    facet_wrap(~LME,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                                    geom_tile() + 
                                     scale_fill_viridis(name = "Lifetime reproductive success", breaks = c(0.4,1,2,4,10,20,40,100,200,400),
                                                        discrete=FALSE,trans='log') + 
                                    theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,1.22, "cm"))

r0.heatmap.pac <- ggplot(pop.dam %>% dplyr::filter(LME == "Pacific (Alaska)"), aes(x=cohort, y=Stock.short, fill= R0.opt)) + 
                                     xlab("") + ylab("")+
                                     facet_wrap(~LME,nrow=3,scales='free_y',strip.position = "right") + scale_x_continuous(labels=NULL) +
                                     geom_tile() + 
                                     scale_fill_viridis(name = "Lifetime reproductive success", breaks = c(0.4,1,2,4,10,20,40,100,200,400),
                                                        discrete=FALSE,trans='log') + 
                                     theme(legend.position = 'top',text = element_text(size=12),plot.margin = margin(0,0.5,0,0, "cm"),
                                           legend.key.width = unit(3,'cm'))

r0.heatmap <- cowplot::plot_grid(r0.heatmap.pac,r0.heatmap.nw,r0.heatmap.ne,nrow = 3,rel_heights = c(3,4,10))
r0.heatmap

save_plot("D:/Github/ICM/Figures/tuned/r0_heatmap.png",r0.heatmap,base_width = 20,base_height = 17)

# Other figures....

# windows(11,11)
# col.try <- rep(rep(c("black","blue","orange",'firebrick2','lightgreen'),3),20)
# pty <- rep(c(rep(21,5),rep(22,5),rep(23,5)),20)

# 
# r0.ts.plt <- ggplot(pop.dam.6,aes(y=R0.opt,x=cohort,group=Stock.short,color=Stock.short,shape = Stock.short,fill = Stock.short)) + 
#                             geom_line(size=2)  + geom_point(size=4) +
#                             scale_y_log10(name = "Lifetime Reproductive Output") +
#                             facet_wrap(~G.Species) +
#                             scale_color_manual(name = "Stock",values = col.try) + scale_shape_manual(name = "Stock",values = pty) +
#                             scale_fill_manual(name = "Stock",values = col.try)+
#                             guides(colour = guide_legend(ncol = 1))+
#                             theme(axis.text.x = element_text(angle =45,hjust=1),legend.key.width = unit(5,'cm')) 
# r0.ts.plt
# 
# save_plot("D:/Github/ICM/Figures/tuned/R0_timeseries_6.png",r0.ts.plt,base_width = 30,base_height = 12)
# 
# r0.boxplt <- ggplot(pop.dam) + geom_boxplot(aes(y=R0.opt,x=Stock.no.species))  + 
#                             scale_y_log10(name = "Lifetime Reproductive Output")+#, breaks = c(0.001,0.01,0.1,1,5,10,50,100),minor_breaks = NULL) + 
#                             facet_wrap(~G.Species,scales = 'free')+
#                             theme(axis.text.x = element_text(angle =45,hjust=1),legend.position = 'none')
# r0.boxplt



# 
# windows(11,11)
# ggplot(pop.dam) + geom_boxplot(aes(y=gen.len.opt,x=Species)) + facet_wrap(~LME,scales='free_x') +
#                   ylab("Generation Length (years)") + theme(axis.text.x = element_text(angle =45,hjust=1))
# 
# windows(11,11)
# col.try <- rep(rep(c("black","blue","orange",'firebrick2','lightgreen'),3),20)
# lty <- rep(c(rep(1,5),rep(2,5),rep(4,5)),20)
# 
# gen.ts.plt <- ggplot(pop.dam.6,aes(y=gen.len.opt,x=cohort,group=Stock.short,color=Stock.short,linetype = Stock.short)) + 
#                             geom_line(size=2)  + 
#                             scale_y_log10(name = "Generation Length") +
#                             facet_wrap(~G.Species) +
#                             scale_color_manual(name = "Stock",values = col.try) + scale_linetype_manual(name = "Stock",values = lty) +
#                             guides(colour = guide_legend(ncol = 1))+
#                             theme(axis.text.x = element_text(angle =45,hjust=1),legend.key.width = unit(5,'cm')) 
# gen.ts.plt
# save_plot("D:/Github/ICM/Figures/tuned/Gen_time_series_6.png",gen.ts.plt,base_width = 20,base_height = 12)

# 
# ggplot(for.tunes) + geom_jitter(aes(y=lambda,x=Species,group=Stock.short,color=Stock.short)) + 
#                     scale_y_continuous(name = 'rate of growth (lambda)',breaks = c(-1,-0.5,0,0.5,1:10)) +
#                             theme(axis.text.x = element_text(angle =45,hjust=1))
# 
# ggplot(for.tunes) + geom_jitter(aes(y=lambda.vpa.init,x=Species)) + scale_y_continuous(name = 'rate of growth (lambda)',breaks = c(-1,-0.5,0,0.5,1:10),limits = c(-1,3))
# 
# unique(for.tunes$Species)
# windows(11,11)
# 
# ggplot(for.tunes) + geom_density(aes(lambda,group=Species,color=Species,fill=Species),alpha = 0.2) + scale_x_continuous(breaks = c(0,0.5,1,2,5,10))
# 
# 
# #options(scipen=999)
# r0.plt <- ggplot(pop.dam) + geom_boxplot(aes(y=R0.opt,x=Area))  + 
#                             scale_y_log10(name = "Lifetime Reproductive Output")+#, breaks = c(0.001,0.01,0.05,0.1,0.5,1,5,10,50,100),minor_breaks = NULL) + 
#                             facet_wrap(~Species,scales = 'free')+
#                             theme(axis.text.x = element_text(angle =45,hjust=1))
# save_plot("D:/Github/ICM/Figures/tuned/R0_ignoring_fishing.png",r0.plt,base_width = 8,base_height = 8)
# 
# 
# 
# vickis.cols <- sort(rep(c( "#172582",  "#F8DC91", "#FBB891", "#FB6A01", "#B80000"),3))
# linetypes <- rep(c(1,2,4),5)
# 
# windows(11,11)
# cod.r0.ts.plt <- ggplot(pop.dam %>% dplyr::filter(Species == 'morhua')) + geom_line(aes(y=R0.opt,x=cohort,group=Area,color=Area,linetype=Area),size=1.5)  + 
#                             scale_y_log10(name = "Lifetime Reproductive Output", breaks = c(0.001,0.01,0.1,1,5,10,50,100),minor_breaks = NULL) + 
#                             scale_color_manual(values = vickis.cols) +
#                             scale_linetype_manual(values = linetypes) +
#                             theme(legend.key.width  = unit(2, "cm"))
# cod.r0.ts.plt
# #save_plot("D:/Github/ICM/Figures/tuned/R0_timeseries_ignoring_fishing.png",r0.plt,base_width = 8,base_height = 8)
# 
# 
# windows(11,11)
# ggplot(pop.dam %>% dplyr::filter(Species =="morhua")) + geom_boxplot(aes(y=R0.opt,x=Area))  + 
#                                                         scale_y_log10(name = "Lifetime Reproductive Output",breaks = c(0.001,0.01,0.1,1,5,10,50,100),minor_breaks = NULL) +
#                                                         theme(axis.text.x = element_text(angle =45,hjust=1))
# 
# # Missing catch questions
# # first did we do much to the Fecundity term to get here
# quantile(for.tunes$mean.fec/for.tunes$mean.vpa.fec,probs=seq(0.01,1,0.01),na.rm=T)
# 
# quantile((for.tunes$removals-for.tunes$removals.init)/for.tunes$removals.init,probs=seq(0.01,1,0.01),na.rm=T)
# quantile((for.tunes$mean.nm-for.tunes$mean.vpa.nm)/for.tunes$mean.vpa.nm,probs=seq(0.01,1,0.01),na.rm=T)
# 
# for.tunes$excess.catch <- for.tunes$removals-for.tunes$removals.init
# for.tunes$per.excess.catch <- 100*((for.tunes$removals-for.tunes$removals.init)/for.tunes$removals.init)
# 
# windows(11,11)
# bycatch.plt <- ggplot(for.tunes) + geom_boxplot(aes(y=per.excess.catch,x=Species)) + 
#                                    ylab("Adjustment to catch (%)") +
#                                    theme(axis.text.x = element_text(angle=45,hjust = 1))
#                                    
# save_plot("D:/Github/ICM/Figures/tuned/Percentage_change_to_bycatch_by_species.png",bycatch.plt,base_width = 8,base_height = 8)
#                                    
# bycatch.plt.cod <- ggplot(for.tunes %>% dplyr::filter(Species == 'morhua')) + geom_boxplot(aes(y=per.excess.catch,x=Area)) + 
#                                                                               ylab("Adjustment to catch (%)") +
#                                                                               theme(axis.text.x = element_text(angle=45,hjust = 1))
#                                                                               
# save_plot("D:/Github/ICM/Figures/tuned/Percentage_change_to_bycatch_by_cod_stock.png",bycatch.plt.cod,base_width = 8,base_height = 8)
# 
# # bycatch.plt <- ggplot(for.tunes) + geom_boxplot(aes(y=per.excess.catch,x=Area)) + facet_wrap(~Species,scales = 'free_x')
# #                                    ylab("Adjustment to catch (%)") +
# #                                    theme(axis.text.x = element_text(angle=45,hjust = 1))
# # bycatch.plt                                   
#                        

# Doubling time for the rest of the stocks...

# dub.heatmap.no.6 <- ggplot(dub.time.summary %>% dplyr::filter(!Species %in% six.species), aes(x=year, y=Stock.short, fill= prop)) + 
#                               xlab("") + ylab("")+                                    
#                               #facet_wrap(~G.Species,nrow=3,scales='free_y',strip.position = "right") + 
#                               scale_x_continuous() +
#                               geom_tile() + scale_fill_viridis(name = "Proportion",discrete=FALSE) + 
#                               theme(legend.position = 'none',text = element_text(size=12),plot.margin = margin(0,0.5,0,0.68, "cm"))
